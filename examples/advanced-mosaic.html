<!DOCTYPE HTML>
<html>
	<head>
		<title>Advanced Mosaic Example</title>
		<!-- Load Natmus.js -->
		<script type="text/javascript" src="../dist/cip+natmus.min.js"></script>
		<!-- Load creadentials -->
		<script type="text/javascript" src="../bitblueprint-credentials.js"></script>
		<!-- Let's use the optional jQuery -->
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
		<link href="advanced-mosaic.css" rel="stylesheet" type="text/css">
	</head>
	<body>
		<header>
			<div id="search-controls">
				<select id="search-catalog"></select>
				<input id="search-term" placeholder="Type a search term and press enter."></input>
			</div>
			<div id="search-status"></div>
		</header>
		<div id="results"></div>
		<div id="asset-lightbox">
			<img>

		</div>

		<script>
		// Set the CIP username and password or get a session from a server.
		// var CIP_USERNAME = "";
		// var CIP_PASSWORD = "";
		if(typeof(CIP_USERNAME) == "undefined") {
			CIP_USERNAME = prompt("Please provide your CIP username.");
		}
		if(typeof(CIP_PASSWORD) == "undefined") {
			CIP_PASSWORD = prompt("Please provide your CIP password.");
		}
		var ASSETS_PR_RESULT = 2; //10;
		var THUMBNAIL_SIZE = 145;
		var LOADING_SESSION_TEXT = "Establishing session.";
		var LOADING_CATEGORIES_TEXT = "Loading categories.";
		var LOADING_ASSETS_TEXT = "Loading assets.";
		var FOUND_NOTHING_TEXT = "Found nothing! Please change your search term or catalog.";

		// Initialize the CIP client.
		nm = new natmus.CIPClient(NatMusConfig);
		console.log("The natmus client was initialized: ", nm);
		$("#search-controls").hide();
		$("#search-status").text(LOADING_SESSION_TEXT);

		// Open a session CIP session.
		nm.session_open(CIP_USERNAME, CIP_PASSWORD,
			function() {
				$("#search-status").text(LOADING_CATEGORIES_TEXT);
				console.log("CIP session established!");
				// First we find the catalogs that we would like to search in.
				nm.get_catalogs(function(catalogs) {
					console.log("Catalogs:", catalogs);
					window.catalogs = catalogs;
					for (c in catalogs) {
						if(catalogs[c].alias) {
							$("<option>")
								.text(catalogs[c].name)
								.data("catalog", catalogs[c])
								.appendTo("#search-catalog");
							$("#search-controls").fadeIn();
						}
					}
					$("#search-status").text("");
				});

				$("#search-term").bind('keyup', function(e) {
					if(e.keyCode == 13) { // Enter!
						var term = $(this).val();
						var catalog = $("#search-catalog option:selected").data("catalog");
						search(catalog, term);
						$("#search-term").select();
					}
				});
			}
		);

		function asset_clicked() {
			var asset = $(this).data('asset');
			console.log("Asset clicked!", asset);
			$lightbox = $("#asset-lightbox");

			var size = Math.max($lightbox.width(), $lightbox.height());
			size = Math.round(size);
			var url = asset.get_preview_url() + "?maxsize="+size;

			$lightbox
				.find("img")
					.attr('src', url)
					.hide()
					.bind('load', function() {
						$(this).fadeIn("slow");
					})
				.end()
				.fadeIn();
		}

		function append_assets_from_result() {
			// We make sure that there is a result loaded.
			if(!window.result) {
				return; // Otherwise - don't do anything.
			}
			// The assets fetched from Cumulus but not loaded as images.
			var $fetched_assets = $("#results .asset");
			// The assets fetched from Cumulus and loaded as images.
			var $lowest_loaded_asset = $("#results .asset:visible:last");
			// Should we load more assets?
			var load_more_assets = false;

			if($fetched_assets.length === 0 || $lowest_loaded_asset.length === 0) {
				// Yes - if no assets has been fetched nor loaded so far.
				load_more_assets = true;
			} else {
				// Yes - if the window is scrolled below the lowest visible asset.
				var scrollBottom = $(window).scrollTop() + $(window).height();
				var bottomNotVisible = $("html").height() - scrollBottom;
				if($lowest_loaded_asset.length === 1 && bottomNotVisible < $lowest_loaded_asset.height()) {
					load_more_assets = true;
				}
			}
			if($fetched_assets.length >= window.result.total_rows) {
				load_more_assets = false; // We got it all ...
			}
			if(load_more_assets) {
				window.result.get(ASSETS_PR_RESULT, $fetched_assets.length, function(assets) {
					for (a in assets) {
						var asset = assets[a];
						var url = asset.get_thumbnail_url({
							size: THUMBNAIL_SIZE
						});
						console.log("Appending asset", asset, url);
						$border = $("<div class='asset'>")
							.hide()
							.appendTo("#results");
						$("<img>")
							.attr('src', url)
							.data('asset', asset)
							.click(asset_clicked)
							.bind('load', function() {
								$(this).parent().fadeIn("slow");
								$loaded_assets = $("#results .asset:visible");
								$("#search-status").text("Loaded " +$loaded_assets.length+ " of " + window.result.total_rows + " assets");
							})
							.appendTo($border);
					}
					// Check if more assets are needed and give some time for rendering.
					setTimeout(append_assets_from_result, 100);
				});
			}
		}

		function check_endless_scrolling() {
			append_assets_from_result();
		}

		var is_searching = false;
		function search(catalog, term) {
			$("#results").empty();
			$("#search-status").hide().text(LOADING_ASSETS_TEXT).fadeIn();
			try {
				// Once the loading toast is showing, we request tables.
				catalog.get_tables(function(tables) {
					console.log("Tables of catalog", catalog, "is", tables);
					var table = tables[0];
					// Search in the first table (ie. the asset records table).
					table.search(term, function(result) {
						console.log("Table search results are in", result);
						if(result.total_rows == 0) {
							$("#search-status").hide().text(FOUND_NOTHING_TEXT).fadeIn();
						} else {
							window.result = result;
							// window.total_assets = result.total_rows;
							// window.loaded_assets = 0;
							append_assets_from_result();
						}
					});
				});
			} catch(err) {
				$("#search-status").hide().text("Error: " + err).fadeIn();
				throw err;
			}
		}

		// When all is loaded.
		$(function() {
			$("#asset-lightbox").click(function() {
				$(this).fadeOut();
			});
			$(window).resize(check_endless_scrolling).scroll(check_endless_scrolling);
		});

		</script>
	</body>
</html>
